# 数据过滤逻辑修改记录

## 修改日期
2025年9月24日

## 修改目标
将客户管理、订单管理、浏览分析、访问统计等模块的数据过滤逻辑从基于 `userId`（用户级别）改为基于 `boutique.id`（店铺级别）。

## 修改范围

### 1. GraphQL 查询修改
修改了以下 GraphQL 查询文件，将过滤参数从 `userId` 改为 `boutiqueId`：

#### `/src/graphql/customers-operations.graphql`
- **原过滤条件**: `filter: { user_created: { id: { _eq: $userId } } }`
- **新过滤条件**: `filter: { boutique: { id: { _eq: $boutiqueId } } }`
- **参数类型**: `$userId: ID` → `$boutiqueId: GraphQLStringOrFloat`

#### `/src/graphql/orders-operations.graphql`
- **原过滤条件**: `filter: { user_created: { id: { _eq: $userId } } }`
- **新过滤条件**: `filter: { boutique: { id: { _eq: $boutiqueId } } }`
- **参数类型**: `$userId: ID` → `$boutiqueId: GraphQLStringOrFloat`

#### `/src/graphql/views-operations.graphql`
- **原过滤条件**: `filter: { user_created: { id: { _eq: $userId } } }`
- **新过滤条件**: `filter: { boutique: { id: { _eq: $boutiqueId } } }`
- **参数类型**: `$userId: ID` → `$boutiqueId: GraphQLStringOrFloat`

#### `/src/graphql/visits-operations.graphql`
- **原过滤条件**: `filter: { user_created: { id: { _eq: $userId } } }`
- **新过滤条件**: `filter: { boutique: { id: { _eq: $boutiqueId } } }`
- **参数类型**: `$userId: ID` → `$boutiqueId: GraphQLStringOrFloat`

### 2. 新增组件

#### `/src/components/BoutiqueSelector.tsx`
- **功能**: 店铺选择器组件，支持搜索和过滤
- **特性**:
  - 获取当前用户的店铺列表
  - 支持搜索店铺名称
  - 显示店铺名称和地址信息
  - 支持清空选择
- **导出**: 已添加到 `/src/components/index.ts`

### 3. 前端页面修改

#### `/src/app/customers/page.tsx` - 客户管理
- **变更**: `userId` → `selectedBoutiqueId`
- **新功能**:
  - 添加店铺选择器
  - 调整搜索区域布局 (6/6 → 6/6/12)
  - 添加空状态提示
  - 必须先选择店铺才能查看数据

#### `/src/app/orders/page.tsx` - 订单管理
- **变更**: `userId` → `selectedBoutiqueId`
- **新功能**:
  - 添加店铺选择器
  - 搜索框在未选择店铺时禁用
  - 刷新和导出按钮在未选择店铺时禁用
  - 添加空状态提示

#### `/src/app/views/page.tsx` - 浏览分析
- **变更**: `userId` → `selectedBoutiqueId`
- **新功能**:
  - 添加店铺选择器
  - 调整筛选器布局 (6/6/4 → 4/5/5/5)
  - 所有筛选控件在未选择店铺时禁用
  - 添加空状态提示

#### `/src/app/visits/page.tsx` - 访问统计
- **变更**: `userId` → `selectedBoutiqueId`
- **新功能**:
  - 用 BoutiqueSelector 替换原有的店铺 Select
  - 简化了店铺选择逻辑
  - 移除了 allBoutiques 查询的依赖

### 4. 数据模型分析
基于 schema.graphql 分析，各表与店铺的关联关系：
- ✅ `customers` - 有 `boutique` 字段
- ✅ `orders` - 有 `boutique` 字段  
- ✅ `views` - 有 `boutique` 字段
- ✅ `visits` - 有 `boutique` 字段
- ❌ `terminals` - 没有 `boutique` 字段，只有 `user_created` 字段

### 5. 未修改的模块

#### `/src/app/terminals/page.tsx` - 终端管理
- **状态**: 保持原有的 `userId` 过滤
- **原因**: `terminals` 表没有 `boutique` 字段关联
- **建议**: 如需按店铺过滤，需要在数据库中添加 `boutique` 字段

## 技术实现细节

### GraphQL 类型调整
- 参数类型从 `ID` 改为 `GraphQLStringOrFloat` 以匹配 schema 要求
- 重新生成了 TypeScript 类型定义 (`npm run codegen`)

### 用户体验优化
- 所有页面都需要先选择店铺才能查看数据
- 提供了清晰的空状态提示
- 搜索和操作按钮在逻辑上禁用，避免无效操作
- 店铺选择器支持搜索，提升大量店铺时的使用体验

### 数据安全
- 每个查询都严格按照 `boutique.id` 过滤
- 用户只能查看自己管理的店铺数据
- 保持了数据隔离和权限控制

## 验证结果
- ✅ GraphQL codegen 成功
- ✅ TypeScript 编译通过
- ✅ Next.js 构建成功
- ✅ 所有修改的页面加载正常

## 使用说明
1. 用户登录后进入各管理页面
2. 首先从下拉列表选择要管理的店铺
3. 选择店铺后，页面显示该店铺的相关数据
4. 可以切换不同店铺查看不同数据
5. 清空店铺选择会回到空状态

## 后续建议
1. 考虑为 `terminals` 表添加 `boutique` 字段以保持一致性
2. 可以添加"记住上次选择的店铺"功能提升用户体验
3. 考虑在 URL 中保存店铺选择状态，支持直接链接分享